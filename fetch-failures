name: Detect and Extract Failing Job Logs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze-failures:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt update
          sudo apt install gh -y

      - name: Authenticate GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: List Failed Jobs
        id: list_failed_jobs
        run: |
          gh run list --limit 10 --json databaseId,status,conclusion,name -q '.[] | select(.conclusion=="failure") | .name' > failed_jobs.txt
          cat failed_jobs.txt

      - name: Download Logs for Failed Jobs
        if: steps.list_failed_jobs.outputs.failed_jobs != ''
        run: |
          while read job_name; do
            echo "Downloading logs for job: $job_name"
            # Replace with actual command to download logs for the job
            # For example, using gh CLI or GitHub API
          done < failed_jobs.txt

      - name: Extract URLs from Logs
        run: |
          # Replace with actual command to extract URLs from logs
          # For example, using grep or a custom script
          echo "Extracting URLs from logs..."
