name: Fetch Failures

on:
  workflow_call:
    inputs:
      pr_head_sha:
        required: true
        type: string
      repo_name:
        required: true
        type: string
    outputs:
      markdown_fragment:
        description: "Markdown fragment listing external check failures"
        value: ${{ jobs.detect.outputs.markdown_fragment }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      markdown_fragment: ${{ steps.build-markdown.outputs.markdown_fragment }}
    steps:
      - name: Fetch Statuses (Currents and Argos)
        id: fetch-statuses
        run: |
          echo "Fetching commit statuses for: ${{ inputs.pr_head_sha }} in repo: ${{ inputs.repo_name }}..."

          STATUS_URL="https://api.github.com/repos/${{ inputs.repo_name }}/commits/${{ inputs.pr_head_sha }}/statuses"
          STATUS_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ vars.GHA_PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$STATUS_URL")

          echo "Raw STATUS_RESPONSE:"
          echo "$STATUS_RESPONSE"

          # Parse the statuses, sanitize context, build table rows
          FAILURES_STATUSES=""
          for row in $(echo "$STATUS_RESPONSE" | jq -c '.[]'); do
            state=$(echo "$row" | jq -r '.state')
            context=$(echo "$row" | jq -r '.context')
            target_url=$(echo "$row" | jq -r '.target_url')
            description=$(echo "$row" | jq -r '.description')

            # Only failure state and matching Currents/Argos context
            if [[ "$state" == "failure" ]] && ([[ "$context" == *"Currents"* ]] || [[ "$context" == *"argos"* ]] || [[ "$context" == *"Argos"* ]]); then
              # Sanitize context (remove "|")
              SAFE_CONTEXT=$(echo "$context" | sed 's/|//g')
              # Append to failures
              FAILURES_STATUSES+=$'| ['$SAFE_CONTEXT'|'${target_url:-"#"}'] | '"$description"$'\n'
            fi
          done

          echo "FAILURES_STATUSES<<EOF" >> $GITHUB_ENV
          echo "$FAILURES_STATUSES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Build Markdown Output
        id: build-markdown
        run: |
          if [ -n "$FAILURES_STATUSES" ]; then
            echo "Detected external failures:"
            echo "$FAILURES_STATUSES"

            HEADER="----
            ðŸš¨ *Detected External Failures:*

            || Failing Tests || Description ||"

            MARKDOWN="$HEADER"$'\n'"$FAILURES_STATUSES"

            echo "markdown_fragment<<EOF" >> $GITHUB_OUTPUT
            echo "$MARKDOWN" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âœ… No failing statuses detected."
            echo "markdown_fragment=" >> $GITHUB_OUTPUT
          fi
